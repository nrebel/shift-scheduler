{% extends "base.html" %}

{% block title %}Shift Preferences{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Enter Shift Preferences</h1>
    <form method="post" id="preferencesForm">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.min_shifts.label(class="form-label") }}
            {{ form.min_shifts(class="form-control", id="min_shifts") }}
        </div>
        <div class="form-group">
            {{ form.max_shifts.label(class="form-label") }}
            {{ form.max_shifts(class="form-control", id="max_shifts") }}
        </div>
        <input type="hidden" id="selectedDates" name="selected_days">
        <button type="submit" class="btn btn-primary" name="save">Save Preferences</button>
    </form>
    <div id="calendar"></div>
</div>

<link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/core/main.min.css' rel='stylesheet' />
<link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/daygrid/main.min.css' rel='stylesheet' />
<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/core/main.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/interaction/main.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/daygrid/main.min.js'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> 

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var selectedDates = new Set();
    
        var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['interaction', 'dayGrid'],
            selectable: true,
            initialView: 'dayGridMonth',
            showNonCurrentDates: false,
            dateClick: function(info) {
                toggleDateSelection(info.dateStr);
            },
            datesSet: function(dateInfo) {
                loadPreferences(dateInfo.start.getFullYear(), dateInfo.start.getMonth() + 1);  // Load preferences when the month changes
            }
        });
    
        calendar.render();
    
        function toggleDateSelection(date) {
            if (selectedDates.has(date)) {
                selectedDates.delete(date);
                calendar.getEventById(date).remove();  // Remove the event
            } else {
                selectedDates.push(date);
                calendar.addEvent({  // Add visual indicator for each date
                    id: date,
                    title: 'Selected',
                    start: date,
                    allDay: true,
                    backgroundColor: '#ff9f89',
                    borderColor: '#ff9f89'
                });
            }
            updateHiddenInput();
        }
    
        function loadPreferences(year, month) {
            $.ajax({
                url: "{{ url_for('fetch_user_schedule') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ year: year, month: month }),
                success: function(data) {
                    //calendar.removeAllEvents();  // Clear all current events
                    selectedDates.clear();
                    if (data.dates) {
                        data.dates.forEach(date => {
                            selectedDates.push(date);
                            calendar.addEvent({  // Add visual indicator for each date
                                id: date,
                                title: 'Selected',
                                start: date,
                                allDay: true,
                                backgroundColor: '#ff9f89',
                                borderColor: '#ff9f89'
                            });
                        });
                    }
                    console.log("[loadPreferences] selectedDates: ", selectedDates);
                    updateHiddenInput();
                },
                error: function() {
                    alert('Failed to load preferences.');
                }
            });
        }
    
        function updateHiddenInput() {
            document.getElementById('selectedDates').value = selectedDates.join(',');
            console.log("[updateHiddenInput] selectedDates: ", selectedDates);
        }
    
        $('#preferencesForm').submit(function(e) {
            e.preventDefault();
            updatePreferences();
        });
    });
    
    function updatePreferences() {
        var year = new Date().getFullYear();
        var month = new Date().getMonth() + 1;  // Adjust month for zero-index
        var minShifts = $('#min_shifts').val();
        var maxShifts = $('#max_shifts').val();

        $.ajax({
            url: "{{ url_for('update_preferences') }}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ year: year, month: month, minShifts: minShifts, maxShifts: maxShifts, dates: selectedDates }),
            success: function(response) {
                alert('Preferences successfully updated!');
                location.reload();  // Optionally reload the page to reflect the new state
            },
            error: function(xhr) {
                alert('Error updating preferences: ' + xhr.statusText);
            }
        });
    }
    </script>
<!-- <script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var selectedDates = [];  // Use a set to keep track of selected dates
    
        var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['interaction', 'dayGrid'],
            selectable: true,
            initialView: 'dayGridMonth',
            showNonCurrentDates: false,
            dateClick: function(info) {
                toggleDateSelection(info.dateStr);
            },
            datesSet: function(dateInfo) {
                loadPreferences(dateInfo.start.getFullYear(), dateInfo.start.getMonth() + 1);  // Load preferences when the month changes
            }
        });
    
        calendar.render();
    
        function toggleDateSelection(date) {
            if (selectedDates.has(date)) {
                selectedDates.delete(date);
                calendar.getEventById(date)?.remove();  // Remove the event
            } else {
                selectedDates.push(date);
                calendar.addEvent({  // Add visual indicator for each date
                    id: date,
                    title: 'Selected',
                    start: date,
                    allDay: true,
                    backgroundColor: '#ff9f89',
                    borderColor: '#ff9f89'
                });
            }
            updateHiddenInput();
        }
    
        function loadPreferences(year, month) {
            $.ajax({
                url: "{{ url_for('fetch_user_schedule') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ year: year, month: month }),
                success: function(data) {
                    calendar.removeAllEvents();  // Clear all current events
                    selectedDates.clear();
                    //selectedDates = data.dates; // Assign fetched dates
                    if (data.dates) {
                        data.dates.forEach(date => {
                            selectedDates.push(date);
                            calendar.addEvent({  // Add visual indicator for each date
                                id: date,
                                selectable: true,
                                title: 'Selected',
                                start: date,
                                allDay: true,
                                backgroundColor: '#ff9f89',
                                borderColor: '#ff9f89'
                            });
                        });
                    }
                    //updateHiddenInput();
                },
                error: function() {
                    alert('Failed to load preferences.');
                }
            });
        }
    
        function updateHiddenInput() {
            document.getElementById('selectedDates').value = selectedDates.join(',');
        }
    
        $('#preferencesForm').submit(function(e) {
            e.preventDefault();
            updatePreferences();
        });
    });
    
    function updatePreferences() {
        var year = new Date().getFullYear();
        var month = new Date().getMonth() + 1;  // Adjust month for zero-index
        var minShifts = $('#min_shifts').val();
        var maxShifts = $('#max_shifts').val();

        selected_dates = document.getElementById('selectedDates').value 
        console.log("selectedDates: ", selectedDates);

        var selected_dates = selectedDates;
    
        $.ajax({
            url: "{{ url_for('update_preferences') }}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ year: year, month: month, minShifts: minShifts, maxShifts: maxShifts, dates: selected_dates }),
            success: function(response) {
                alert('Preferences successfully updated!');
                location.reload();  // Optionally reload the page to reflect the new state
                calendar.refetchEvents(); // Refresh calendar to show updated preferences
            },
            error: function(xhr) {
                alert('Error updating preferences: ' + xhr.statusText);
            }
        });
    }
</script> -->

<!-- <script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var selectedDates = [];  // Corrected to use Set for easier management
    
        var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['interaction', 'dayGrid'],
            selectable: true,
            select: console.log,
            initialView: 'dayGridMonth',
            showNonCurrentDates: false,
            dateClick: function(info) {
                toggleDateSelection(info.dateStr);
            },
            datesSet: function(dateInfo) {
                // Load preferences when the month changes
                loadPreferences(dateInfo.start.getFullYear(), dateInfo.start.getMonth() + 1);
            }
        });
    
        calendar.render();
    
        function toggleDateSelection(date) {
            if (selectedDates.has(date)) {
                selectedDates.delete(date);
                calendar.getEventById(date).remove();  // Use optional chaining in case the event does not exist
            } else {
                selectedDates.add(date);
                calendar.addEvent({  // Add visual indicator for each date
                    id: date,
                    title: 'Selected',
                    start: date,
                    allDay: true,
                    backgroundColor: '#ff9f89',
                    borderColor: '#ff9f89'
                });
            }
            //updateHiddenInput();
        }
    
        function loadPreferences(year, month) {
            $.ajax({
                url: "{{ url_for('fetch_user_schedule', _external=True) }}",  // Ensure URL is generated correctly
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ year: year, month: month }),
                success: function(data) {
                    calendar.removeAllEvents();  // Clear all current events
                    selectedDates.clear();  // Clear the selectedDates to sync with fetched data
                    if (data.dates) {
                        data.dates.forEach(function(date) {
                            selectedDates.add(date);
                            calendar.addEvent({  // Add visual indicator for each date
                                id: date,
                                title: 'Selected',
                                start: date,
                                allDay: true,
                                backgroundColor: '#ff9f89',
                                borderColor: '#ff9f89'
                            });
                        });
                    }
                    updateHiddenInput();
                },
                error: function() {
                    alert('Failed to load preferences.');
                }
            });
        }
    
        function updateHiddenInput() {
            document.getElementById('selectedDates').value = Array.from(selectedDates).join(',');
        }
    
        $('#preferencesForm').submit(function(e) {
            e.preventDefault();
            updatePreferences();
        });
    });
    
    function updatePreferences() {
        var year = new Date().getFullYear();
        var month = new Date().getMonth() + 1;  // Adjust month for zero-index
        var minShifts = $('#min_shifts').val();
        var maxShifts = $('#max_shifts').val();
    
        var selected_dates = Array.from(selectedDates);  // Convert Set to Array for JSON serialization
    
        $.ajax({
            url: "{{ url_for('update_preferences', _external=True) }}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                year: year,
                month: month,
                minShifts: minShifts,
                maxShifts: maxShifts,
                dates: selected_dates
            }),
            success: function(response) {
                alert('Preferences successfully updated!');
                location.reload();  // Optionally reload the page to reflect the new state
            },
            error: function(xhr) {
                alert('Error updating preferences: ' + xhr.statusText);
            }
        });
    }
    </script> -->
    
{% endblock %}


<!-- <script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var selectedDates = new Set();  // Use a set to keep track of selected dates
    
        var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['interaction', 'dayGrid'],
            selectable: true,
            initialView: 'dayGridMonth',
            showNonCurrentDates: false,
            dateClick: function(info) {
                toggleDateSelection(info.dateStr, info.dayEl);
            },
            datesSet: function() {
                loadPreferences(calendar);  // Load preferences when the month changes
            }
        });
    
        calendar.render();
    
        function toggleDateSelection(date, element) {
            if (selectedDates.has(date)) {
                selectedDates.delete(date);
                element.style.backgroundColor = '';  // Remove selection style
            } else {
                selectedDates.add(date);
                element.style.backgroundColor = '#ff9f89';  // Apply selection style
            }
            updateHiddenInput();
            loadPreferences(calendar);
        }
    
        function loadPreferences(calendar) {
            var currentDate = calendar.getDate(); // Get the current date of the calendar
            var year = currentDate.getFullYear(); // Extract the year from the current date
            var month = currentDate.getMonth() + 1; // Extract the month from the current date (getMonth() is zero-indexed so add 1)
    
            var current_user = "{{ current_user.username }}";
            $.ajax({
                url: "{{ url_for('fetch_user_schedule') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ user: current_user, year: year, month: month }),
                success: function(data) {
                    calendar.removeAllEvents();  // Clear all current events
                    if (data.dates) {
                        data.dates.forEach(date => {
                            selectedDates.add(date);  // Add to selected dates
                            calendar.addEvent({  // Add visual indicator for each date
                                title: 'Selected',
                                start: date,
                                allDay: true,
                                backgroundColor: '#ff9f89',
                                borderColor: '#ff9f89'
                            });
                        });
                    }
                    updateHiddenInput();
                },
                error: function() {
                    alert('Failed to load preferences.');
                }
            });
        }
    
        function updateHiddenInput() {
            document.getElementById('selectedDates').value = Array.from(selectedDates).join(',');
        }
    
        $('#preferencesForm').submit(function(e) {
            e.preventDefault();
            updatePreferences(calendar, Array.from(selectedDates));
        });
    });
    
    function updatePreferences(calendar, selectedDates) {
        var startDate = calendar.getDate();
        var year = startDate.getFullYear();
        var month = startDate.getMonth() + 1; // Adjust month for zero-index
        var minShifts = $('#min_shifts').val();
        var maxShifts = $('#max_shifts').val();
    
        $.ajax({
            url: "{{ url_for('update_preferences') }}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ year: year, month: month, minShifts: minShifts, maxShifts: maxShifts, dates: selectedDates }),
            success: function(response) {
                alert('Preferences successfully updated!');
                calendar.refetchEvents(); // Refresh calendar to show updated preferences
            },
            error: function(xhr) {
                alert('Error updating preferences: ' + xhr.statusText);
            }
        });
    }
    </script> -->